name: Discord Webhook Test

on:
  workflow_dispatch:  # This allows manual triggering from the GitHub UI

jobs:
  simulate-task:
    runs-on: ubuntu-latest
    outputs:
      added_instructions: ${{ steps.generate-manifest.outputs.added_instructions }}
      total_instructions: ${{ steps.generate-manifest.outputs.total_instructions }}
      included_messages: ${{ steps.generate-manifest.outputs.included_messages }}
      skipped_messages: ${{ steps.generate-manifest.outputs.skipped_messages }}
    steps:
      - name: Simulate Return
        id: generate-manifest
        run: |
          echo "added_instructions=1" >> "$GITHUB_OUTPUT"
          echo "total_instructions=5" >> "$GITHUB_OUTPUT"
          echo "included_messages=3" >> "$GITHUB_OUTPUT"
          echo "skipped_messages=2" >> "$GITHUB_OUTPUT"

  send-discord-message:
    name: Post Discord Webhook
    needs: simulate-task
    if: always()
    runs-on: ubuntu-latest
    steps:
    - uses: "hugoalh/send-discord-webhook-ghaction@v7.0.0"
      with:
        key: "${{secrets.DISCORD_WEBHOOK_URL}}"
        username: "GopherMaps Data"
        avatar_url: "https://github.com/ryan-roche/gophermaps-data/blob/main/webhook-icons/gw-data.png?raw=true"
        embeds: |
          [
            {
              "author": {
                "name": "Generate manifest.json",
                "url": "https://github.com/ryan-roche/gophermaps-data/actions/workflows/manifest-generator.yml",
                "icon_url": "https://github.com/github.png"
              },
              "title": "${{ needs.simulate-task.result == 'success' && 'Job Succeeded' || 'Job Failed' }}",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": ${{ needs.simulate-task.result == 'success' && 4029719 || 12845056 }},
              "fields": [
              # TODO programatically populate fields depending on result of generation job
                {
                  "name": "📜  Instructions",
                  "value": "- 📄  Added ${{ needs.simulate-task.outputs.added_instructions }}\n - 🗃️  Total: ${{ needs.simulate-task.outputs.total_instructions }}",
                },
                {
                  "name": "📣  Server Messages",
                  "value": "- 📥  ${{ needs.simulate-task.outputs.included_messages }} included\n - ⏭️  ${{ needs.simulate-task.outputs.skipped_messages }} skipped",
                }
              ],
              "thumbnail": {
                "url": "https://github.com/actions-user.png"
              }
            }
            # TODO add extra embed for if any instructions were ill-formatted
            # TODO add extra embed for if any serverMessages were ill-formatted
          ]
